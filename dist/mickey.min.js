!function(n,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):"object"==typeof exports?exports.Mickey=t():n.Mickey=t()}(this,function(){return function(n){function t(r){if(e[r])return e[r].exports;var o=e[r]={exports:{},id:r,loaded:!1};return n[r].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var e={};return t.m=n,t.c=e,t.p="",t(0)}([function(n){function t(n){var t=function(t){var e=g[t.keyCode];"click"===e?n.click():e&&n.move(e)};return{bind:_.bind(document.addEventListener,document,"keydown",t),unbind:_.bind(document.removeEventListener,document,"keydown",t)}}function e(n,t){var e;return _.isUndefined(window.MutationObserver)?(t=_.debounce(t,0),n.addEventListener("DOMSubtreeModified",t),e={disconnect:function(){n.removeEventListener("DOMSubtreeModified",t)}}):(e=new MutationObserver(t),e.observe(n,{attributes:!0,childList:!0,characterData:!0,subtree:!0})),e}function r(n,t){return n.querySelector(t)}function o(n,t){return _.toArray(n.querySelectorAll(t))}function i(n,t,e){n&&e!==!1&&n.classList.add(t)}function u(n,t,e){n&&e!==!1&&n.classList.remove(t)}function a(){return{x:0,y:0}}function c(n,t){return{x:t.x-n.x,y:t.y-n.y}}function s(n,t){return l(c(n,t))}function f(n,t,e){return l(p(c(n,t),e))}function l(n){return Math.abs(n.x)+Math.abs(n.y)}function d(n){return{x:-n.x,y:-n.y}}function v(n,t){return n.x*t.x+n.y*t.y}function h(n,t){return{x:2*t.x-n.x,y:2*t.y-n.y}}function y(n,t,e){return{x:n.x+2*(t.x-n.x)*Math.abs(e.x),y:n.y+2*(t.y-n.y)*Math.abs(e.y)}}function p(n,t){var e=v(n,t);return{x:e*t.x,y:e*t.y}}function b(n,t){return function(e){return _.isUndefined(e.dataset[n])?0:t}}function k(n){if(n){var t=n.getBoundingClientRect();return t.height>0||t.width>0?new x(n,t):void 0}}function x(n,t){this.el=n,this._r=t}function m(n,l){function p(n,t){if(n){var e=document.createEvent("MouseEvents"),r=P.pos.x,o=P.pos.y;e.initMouseEvent(t,!0,!0,window,0,r,o,r,o,!1,!1,!1,!1,0,null),n.dispatchEvent(e)}}function b(t){return!(!t||_.isUndefined(t.dataset.navArea)&&t!==n)}function m(n){return!!n&&!_.isUndefined(n.dataset.navLimit)}function g(n){return!!n&&!_.isUndefined(n.dataset.navTrack)}function S(n,t){if(!n||_.isUndefined(n.dataset.navCircular))return!1;var e=n.dataset.navCircular;return""===e||E[t]===e}function A(n,t){return!!t&&m(n)&&n.dataset.navLimit===M[t]}function j(n){return!!n&&!_.isUndefined(n.dataset.navSelected)}function O(n,t,e,r){var o=e?w[e]:a(),i=d(o);n instanceof x&&(n=n.bound(o));var u=function(t){return v(c(n,t),o)>=-l.overlap},h=_.map(_.filter(_.map(t,k),function(n){return n&&u(r?n.bound(i):n.center())}),function(t){return{el:t.el,proj:f(n,t.bound(i),o),dist:s(n,t.bound(i))}});return h=_.sortBy(h,function(n){return n.proj}),h.length>1&&h[0].proj===h[1].proj&&(h=_.sortBy(h,function(n){return n.dist})),h[0]&&h[0].el}function U(n,t){var e=k(O(n,t));return e&&e.contains(n)?e.el:void 0}function B(){var t=o(n,l.$area);return t.length?t:[n]}function I(){var n=B();return _.some(n,j)&&(n=_.sortBy(n,L)),_.first(n)}function q(n,t){var e=o(n,n.dataset.navArea||l.$href),r=_.some(e,m);return r&&(e=_.sortBy(e,C)),r&&t?_.filter(e,function(n){return!m(n)||A(n,t)}):e}function D(n){return P.focus(P.closest()||I(),n,!0)}if(!n)throw new Error("mickey: should pass a parent DOM element");var $=!1,z=!1;l=_.defaults(l||{},{hoverClass:"hover",areaClass:"hover",trackClass:"tracked",overlap:0,position:null,listener:t,$area:"[data-nav-area]",$href:null});var N,P={pos:l.position||a(),el:null,ar:null},T=l.listener(P),J=_.once(function(){N=e(n,Z),T.bind&&T.bind(n)}),R=_.once(function(){N&&N.disconnect(),T.unbind&&T.unbind()});P.focus=function(t,e,r){if(_.isString(t)&&(t=n.querySelector(t)),b(t))return P.focus(P.defaults(t));var o=k(t);if(!o)return!1;var a=t,c=P.area(a),s=P.el,f=P.ar,d=m(a),v=c!==f;return v&&(P.ar=c,u(f,l.areaClass),i(c,l.areaClass)),a===s||c===f&&d&&!r||(P.pos=o.center(),P.el=a,u(s,l.hoverClass),i(s,l.trackClass,v&&g(f)),u(a,l.trackClass),i(a,l.hoverClass,!d),p(s,"mouseout"),p(a,"mouseover")),d&&A(a,e)&&P.click(t),z||(z=!0),!0},P.position=function(){return{x:P.pos.x,y:P.pos.y}},P.move=function(n){if($)throw new Error("mickey: locked");var t=P.el,e=k(t);if(e){var o=P.area(),i=_.without(q(o,n),t),u=O(e,i,n);if(u)return P.focus(u,n);var a=+o.dataset.navZIndex;if(!(a>0)){if(S(o,n))return P.focus(P.circular(n));var c=k(o),s=_.without(B(),o),f=O(c,s,n,!0);if(!f)return A(P.el,n)?P.click():!1;var d=q(f);if(1===d.length&&A(d[0],n))return P.click(d[0]);if(g(o)&&(o.dataset.navTrackPos=JSON.stringify(P.pos)),g(f)){var v=f.dataset.navTrackPos,h=r(f,"."+l.trackClass);u=h||v&&O(JSON.parse(v),d)}return P.focus(u||d[0],n)}}else if(!D(n))throw new Error("mickey: cannot move")},P.click=function(t){if($||!z)throw new Error("mickey: locked");if(t=t||P.el,!n.contains(t))throw new Error("mickey: cannot click on non visible element");if(!t&&!D())throw new Error("mickey: cannot click");return p(t,"click"),!0},P.area=function(t){for(t=t||P.el;t&&t!==n;)if(t=t.parentNode,b(t))return t;return n},P.closest=function(n){var t=_.flatten(_.map(n?[n]:B(),q));return O(P.pos,t)},P.closestInArea=function(){return P.closest(P.ar)},P.defaults=function(n){return _.first(q(n||I()))},P.defaultsInArea=function(){return P.defaults(P.ar)},P.hovered=function(){var n=_.flatten(_.map(B(),q));return U(P.pos,n)},P.circular=function(n){var t,e=k(P.ar).center();return t=n?y(k(P.el).bound(w[n]),e,w[n]):h(P.pos,e),O(t,q(P.ar),n)},P.block=function(){$=!0,i(P.el,"blocked")},P.unblock=function(){$=!1,u(P.el,"blocked")},P.clear=_.once(function(){R(),P.pos=a(),P.el=null,P.ar=null,n=null,$=!1,T=null}),P.update=function(){P.focus(P.closest())},P.init=function(){if(z)throw new Error("mickey: already initialized");return J(),P.focus(l.position?P.hovered():P.defaults()),P};var Z=function(){if(!z)return P.init();if(n&&!n.contains(P.el)){var t,e=P.ar;switch(e.dataset.navPolicy){default:case"closest":t=P.closestInArea();break;case"defaults":t=P.defaultsInArea();break;case"hovered":t=P.hovered();break;case"circular":t=P.circular()}P.focus(t,null,!0)}};return P}if(!_)throw new Error("mickey: lodash or underscore is required");var w={left:{x:-1,y:0},up:{x:0,y:-1},right:{x:1,y:0},down:{x:0,y:1}},g={37:"left",38:"up",39:"right",40:"down",13:"click"},M={left:"left",up:"top",right:"right",down:"bottom"},E={left:"horizontal",right:"horizontal",up:"vertical",down:"vertical"},C=b("navLimit",1),L=b("navSelected",-1);x.prototype.contains=function(n){var t=this.center(),e=c(t,this.bound(w.down)),r=c(t,this.bound(w.right)),o=c(t,n);return 2*Math.abs(v(e,o))<=this._r.height&&2*Math.abs(v(r,o))<=this._r.width},x.prototype.center=function(){return{x:this._r.left+this._r.width/2,y:this._r.top+this._r.height/2}},x.prototype.bound=function(n){return{x:this._r.left+this._r.width*(1+n.x)/2,y:this._r.top+this._r.height*(1+n.y)/2}},n.exports=m}])});